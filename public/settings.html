<!DOCTYPE html>
<html lang="en" data-title-suffix="Settings">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wedding Jukebox - Settings</title>
    
    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512.png">
    
    <link href="css/output.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .settings-container {
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .setting-item {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }
        
        .setting-item:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-2px);
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #8b5cf6;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .service-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-enabled {
            background: #10b981;
            color: white;
        }
        
        .status-disabled {
            background: #6b7280;
            color: white;
        }
        
        .status-unavailable {
            background: #ef4444;
            color: white;
        }
    </style>
</head>
<body class="text-white">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-pink-400 to-purple-400 bg-clip-text text-transparent">
                <i class="fas fa-cog mr-3"></i><span data-event-text="appName">Wedding Jukebox</span> Settings
            </h1>
            <p class="text-xl text-gray-300">Customize your music experience</p>
            <div class="mt-4">
                <a href="/" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-full transition-colors mr-2">
                    <i class="fas fa-arrow-left mr-2"></i>Return to DJ Interface
                </a>
                <a href="/logout" class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-2 rounded-full transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </a>
            </div>
        </header>

            <div class="settings-container p-8">
            <!-- Quick Tools -->
            <section class="mb-8">
                <h2 class="text-2xl font-bold mb-4 flex items-center">
                    <i class="fas fa-toolbox mr-3 text-yellow-300"></i>
                    Quick Tools
                </h2>
                <div class="setting-item p-6 mb-4 flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Audio Cache</h3>
                        <p class="text-gray-300 text-sm">View cached audio files stored on the Pi</p>
                    </div>
                    <a href="/cache" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm">View Cache</a>
                </div>
                <div class="setting-item p-6 mb-4 flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Clear Audio Cache</h3>
                        <p class="text-gray-300 text-sm">Remove all cached audio files from the Pi</p>
                    </div>
                    <button id="clearCacheBtn" class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded-lg text-sm">Clear Cache</button>
                </div>
                <div class="setting-item p-6 mb-4 flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Venue WiFi Console</h3>
                        <p class="text-gray-300 text-sm">Scan and connect the uplink WiFi</p>
                    </div>
                    <a href="/venue" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm">Open Console</a>
                </div>
            </section>
            <!-- Audio Visualizer Settings -->
            <section class="mb-8">
                <h2 class="text-2xl font-bold mb-4 flex items-center">
                    <i class="fas fa-wave-square mr-3 text-purple-400"></i>
                    Audio Visualizer
                </h2>
                
                <div class="setting-item p-6 mb-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Enable Visualizer</h3>
                            <p class="text-gray-300 text-sm">Show animated visual effects during music playback</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="visualizerEnabled" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="setting-item p-6 mb-4" id="visualizerSettings">
                    <h3 class="text-lg font-semibold mb-4">Visualizer Preferences</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Default Visualization Type</label>
                            <select id="defaultVisualizerType" class="w-full bg-gray-700 text-white rounded px-3 py-2">
                                <option value="bars">Frequency Bars</option>
                                <option value="waveform">Waveform</option>
                                <option value="circular">Circular</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Auto-show Behavior</label>
                            <select id="autoShowBehavior" class="w-full bg-gray-700 text-white rounded px-3 py-2">
                                <option value="always">Always show when music starts</option>
                                <option value="spotify-only">Only for Spotify previews</option>
                                <option value="never">Never auto-show</option>
                            </select>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Playback Settings -->
            <section class="mb-8">
                <h2 class="text-2xl font-bold mb-4 flex items-center">
                    <i class="fas fa-sliders-h mr-3 text-teal-300"></i>
                    Playback
                </h2>
                
                <div class="setting-item p-6 mb-4">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Fade to Next Duration (ms)</h3>
                            <p class="text-gray-300 text-sm">How long the song fades out before advancing to the next track (500-10000 ms)</p>
                        </div>
                        <input id="fadeDurationMs" type="number" min="500" max="10000" step="100"
                               class="w-40 bg-gray-700 text-white rounded px-3 py-2" value="2000">
                    </div>
                </div>

                <div class="setting-item p-6 mb-4">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Audio Output</h3>
                            <p class="text-gray-300 text-sm">Choose which speaker/device to play through</p>
                        </div>
                        <select id="audioOutputDevice" class="w-full md:w-96 bg-gray-700 text-white rounded px-3 py-2">
                            <option value="default">Default (system)</option>
                        </select>
                    </div>
                </div>

                <div class="setting-item p-6 mb-4">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">System Mode</h3>
                            <p class="text-gray-300 text-sm">Choose how audio plays: headless service or in-browser.</p>
                        </div>
                        <select id="systemMode" class="w-full md:w-72 bg-gray-700 text-white rounded px-3 py-2">
                            <option value="headless">Headless (Audio Service)</option>
                            <option value="browser">Browser (DJ Page)</option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- Event Branding -->
            <section class="mb-8">
                <h2 class="text-2xl font-bold mb-4 flex items-center">
                    <i class="fas fa-palette mr-3 text-pink-300"></i>
                    Event Branding
                </h2>

                <div class="setting-item p-6 mb-4">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Preset Theme</h3>
                            <p class="text-gray-300 text-sm">Quickly swap the UI for a different event</p>
                        </div>
                        <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                            <select id="eventPreset" class="w-full md:w-72 bg-gray-700 text-white rounded px-3 py-2">
                                <option value="">Custom</option>
                                <option value="wedding">Wedding</option>
                                <option value="dojo">Dojo</option>
                                <option value="house">House Party</option>
                                <option value="studio">Training Studio</option>
                            </select>
                            <button id="applyPresetBtn" class="bg-pink-600 hover:bg-pink-500 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                Apply Preset
                            </button>
                        </div>
                    </div>
                    <div id="presetCards" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-3 mt-4"></div>
                </div>

                <div class="setting-item p-6 mb-4">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Save As Custom</h3>
                            <p class="text-gray-300 text-sm">Save the current branding so you can re-use it later</p>
                        </div>
                        <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                            <input id="customPresetName" type="text" class="w-full md:w-72 bg-gray-700 text-white rounded px-3 py-2" placeholder="Custom preset name">
                            <button id="savePresetBtn" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                Save Custom
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Event Schedule -->
            <section class="mb-8">
                <h2 class="text-2xl font-bold mb-4 flex items-center">
                    <i class="fas fa-calendar-alt mr-3 text-amber-200"></i>
                    Event Schedule
                </h2>
                <div class="setting-item p-6 mb-4">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Events & Playlists</h3>
                            <p class="text-gray-300 text-sm">Define event segments (ceremony, dinner, party) and assign a playlist + loop setting.</p>
                        </div>
                        <button id="addEventBtn" class="bg-amber-600 hover:bg-amber-500 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                            Add Event
                        </button>
                    </div>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium mb-2">Fallback Playlist</label>
                            <select id="fallbackPlaylistFile" class="w-full bg-gray-700 text-white rounded px-3 py-2">
                                <option value="">Select fallback playlist</option>
                            </select>
                        </div>
                        <div class="text-xs text-gray-400 flex items-end">
                            Used when the queue is empty and an event finishes without looping.
                        </div>
                    </div>
                    <div id="eventList" class="space-y-3 mt-4"></div>
                    <div class="mt-4 flex flex-col md:flex-row gap-2">
                        <button id="saveEventScheduleBtn" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                            Save Event Schedule
                        </button>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Events are saved per theme and persist on the Pi.</p>
                </div>
            </section>

            <!-- Playlist Files -->
            <section class="mb-8">
                <h2 class="text-2xl font-bold mb-4 flex items-center">
                    <i class="fas fa-folder-open mr-3 text-amber-300"></i>
                    Playlist Files
                </h2>

                <div class="setting-item p-6 mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Primary Playlist File</label>
                            <select id="primaryPlaylistFile" class="w-full bg-gray-700 text-white rounded px-3 py-2">
                                <option value="">Default (wedding-playlist.js)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Secondary Playlist File</label>
                            <select id="secondaryPlaylistFile" class="w-full bg-gray-700 text-white rounded px-3 py-2">
                                <option value="">Default (bride-playlist.js)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-4 flex flex-col md:flex-row gap-2">
                        <input id="playlistUploadInput" type="file" accept=".js,.json" class="w-full md:w-72 bg-gray-700 text-white rounded px-3 py-2">
                        <button id="uploadPlaylistBtn" class="bg-amber-600 hover:bg-amber-500 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                            Upload Playlist
                        </button>
                        <button id="savePlaylistFilesBtn" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                            Save Playlist Selection
                        </button>
                    </div>
                    <div class="mt-3 flex flex-col md:flex-row gap-2">
                        <input id="createPlaylistName" type="text" class="w-full md:w-72 bg-gray-700 text-white rounded px-3 py-2" placeholder="new-playlist.js">
                        <button id="createPlaylistBtn" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                            Create Playlist File
                        </button>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Files are stored in `/app/playlists` and persist across Docker rebuilds.</p>
                </div>
            </section>

            <!-- Music Services Settings -->
            <section class="mb-8">
                <h2 class="text-2xl font-bold mb-4 flex items-center">
                    <i class="fas fa-music mr-3 text-green-400"></i>
                    Music Services
                </h2>
                
                <!-- YouTube Music -->
                <div class="setting-item p-6 mb-4">
                    <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <i class="fab fa-youtube text-red-500 mr-3 text-xl"></i>
                                <h3 class="text-lg font-semibold">YouTube Music</h3>
                                <span class="service-status status-enabled ml-3">ENABLED</span>
                            </div>
                            <p class="text-gray-300 text-sm">Primary music service with full song playback</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="youtubeEnabled" checked disabled>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <!-- Spotify -->
                <div class="setting-item p-6 mb-4">
                    <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <i class="fab fa-spotify text-green-500 mr-3 text-xl"></i>
                                <h3 class="text-lg font-semibold">Spotify</h3>
                                <span class="service-status status-enabled ml-3" id="spotifyStatus">ENABLED</span>
                            </div>
                            <p class="text-gray-300 text-sm">30-second previews with real audio visualization</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="spotifyEnabled" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <!-- SoundCloud (Future) -->
                <div class="setting-item p-6 mb-4 opacity-60">
                    <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <i class="fab fa-soundcloud text-orange-500 mr-3 text-xl"></i>
                                <h3 class="text-lg font-semibold">SoundCloud</h3>
                                <span class="service-status status-unavailable ml-3">COMING SOON</span>
                            </div>
                            <p class="text-gray-300 text-sm">Independent artist tracks and remixes</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="soundcloudEnabled" disabled>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <!-- Apple Music (Future) -->
                <div class="setting-item p-6 mb-4 opacity-60">
                    <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <i class="fab fa-apple text-gray-400 mr-3 text-xl"></i>
                                <h3 class="text-lg font-semibold">Apple Music</h3>
                                <span class="service-status status-unavailable ml-3">COMING SOON</span>
                            </div>
                            <p class="text-gray-300 text-sm">Apple's music streaming service integration</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="appleMusicEnabled" disabled>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </section>

            <!-- Interface Settings -->
            <section class="mb-8">
                <h2 class="text-2xl font-bold mb-4 flex items-center">
                    <i class="fas fa-palette mr-3 text-blue-400"></i>
                    Interface
                </h2>
                
                <div class="setting-item p-6 mb-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Show Service Icons</h3>
                            <p class="text-gray-300 text-sm">Display music service icons in search results</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="showServiceIcons" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="setting-item p-6 mb-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Compact Queue View</h3>
                            <p class="text-gray-300 text-sm">Show more songs in the queue with smaller cards</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="compactQueue">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </section>

            <!-- Save Settings -->
            <div class="text-center">
                <button id="saveAndReturn" class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white px-8 py-3 rounded-full text-lg font-semibold transition-all transform hover:scale-105 shadow-lg mr-4">
                    <i class="fas fa-check mr-2"></i>Apply & Return
                </button>
                <button id="saveSettings" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white px-8 py-3 rounded-full text-lg font-semibold transition-all transform hover:scale-105 shadow-lg">
                    <i class="fas fa-save mr-2"></i>Save Settings
                </button>
                <button id="resetSettings" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-full ml-4 transition-colors">
                    <i class="fas fa-undo mr-2"></i>Reset to Defaults
                </button>
            </div>
        </div>
    </div>

    <script src="js/event-config.js"></script>
    <script>
        class SettingsManager {
            constructor() {
                this.settings = this.loadSettings();
                this.eventConfig = null;
                this.customPresets = {};
                this.playlistFiles = [];
                this.eventSchedule = [];
                this.activeEventId = null;
                this.systemMode = 'headless';
                this.initializeUI();
                this.bindEvents();
            }
            
            loadSettings() {
                const defaultSettings = {
                    visualizerEnabled: true,
                    defaultVisualizerType: 'bars',
                    autoShowBehavior: 'always',
                    youtubeEnabled: true,
                    spotifyEnabled: true,
                    soundcloudEnabled: false,
                    appleMusicEnabled: false,
                    showServiceIcons: true,
                    compactQueue: false,
                    fadeDurationMs: 2000,
                    audioOutputDevice: 'default'
                };
                
                const saved = localStorage.getItem('jukeboxSettings');
                return saved ? { ...defaultSettings, ...JSON.parse(saved) } : defaultSettings;
            }
            
            saveSettings() {
                localStorage.setItem('jukeboxSettings', JSON.stringify(this.settings));
                this.showToast('Settings saved successfully!', 'success');
                
                // Try to apply settings to main window if it exists
                this.applyToMainWindow();
                this.applyAudioOutput();
            }
            
            saveAndReturn() {
                this.saveSettings();
                // Go back to main jukebox
                window.location.href = '/';
            }
            
            applyToMainWindow() {
                // If the main jukebox window is open, apply settings there
                try {
                    if (window.opener && window.opener.jukebox) {
                        window.opener.jukebox.applySettings();
                        this.showToast('Settings applied to main window', 'info');
                    }
                } catch (error) {
                    // Ignore errors if main window is not accessible
                }
            }
            
            initializeUI() {
                // Set all form values from settings
                Object.keys(this.settings).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = this.settings[key];
                        } else {
                            element.value = this.settings[key];
                        }
                    }
                });
                
                this.updateVisualizerSettingsVisibility();
                this.loadAudioOutputs();
                this.loadSystemMode();
                this.loadEventConfig();
                this.loadPlaylistFiles();
                this.loadEventSchedule();
            }
            
            bindEvents() {
                // Visualizer enable/disable
                document.getElementById('visualizerEnabled').addEventListener('change', (e) => {
                    this.settings.visualizerEnabled = e.target.checked;
                    this.updateVisualizerSettingsVisibility();
                });
                
                // All other settings
                ['defaultVisualizerType', 'autoShowBehavior', 'youtubeEnabled', 'spotifyEnabled', 
                 'soundcloudEnabled', 'appleMusicEnabled', 'showServiceIcons', 'compactQueue', 'fadeDurationMs', 'audioOutputDevice'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('change', (e) => {
                            this.settings[id] = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
                            if (id === 'audioOutputDevice') {
                                this.applyAudioOutput();
                            }
                        });
                    }
                });
                
                // Save and reset buttons
                document.getElementById('saveSettings').addEventListener('click', () => this.saveSettings());
                document.getElementById('saveAndReturn').addEventListener('click', () => this.saveAndReturn());
                document.getElementById('resetSettings').addEventListener('click', () => this.resetToDefaults());

                const clearCacheBtn = document.getElementById('clearCacheBtn');
                if (clearCacheBtn) {
                    clearCacheBtn.addEventListener('click', async () => {
                        if (!confirm('Clear all cached audio files?')) return;
                        await fetch('/api/cache/clear', { method: 'POST' });
                        this.showToast('Cache cleared', 'success');
                    });
                }

                const applyPresetBtn = document.getElementById('applyPresetBtn');
                if (applyPresetBtn) {
                    applyPresetBtn.addEventListener('click', () => this.applyPreset());
                }

                const savePresetBtn = document.getElementById('savePresetBtn');
                if (savePresetBtn) {
                    savePresetBtn.addEventListener('click', () => this.saveCustomPreset());
                }

                const uploadPlaylistBtn = document.getElementById('uploadPlaylistBtn');
                if (uploadPlaylistBtn) {
                    uploadPlaylistBtn.addEventListener('click', () => this.uploadPlaylistFile());
                }

                const savePlaylistFilesBtn = document.getElementById('savePlaylistFilesBtn');
                if (savePlaylistFilesBtn) {
                    savePlaylistFilesBtn.addEventListener('click', () => this.savePlaylistFiles());
                }

                const createPlaylistBtn = document.getElementById('createPlaylistBtn');
                if (createPlaylistBtn) {
                    createPlaylistBtn.addEventListener('click', () => this.createPlaylistFile());
                }

                const systemModeSelect = document.getElementById('systemMode');
                if (systemModeSelect) {
                    systemModeSelect.addEventListener('change', (event) => {
                        this.systemMode = event.target.value;
                        this.saveSystemMode();
                    });
                }

                const addEventBtn = document.getElementById('addEventBtn');
                if (addEventBtn) {
                    addEventBtn.addEventListener('click', () => this.addEvent());
                }

                const saveEventScheduleBtn = document.getElementById('saveEventScheduleBtn');
                if (saveEventScheduleBtn) {
                    saveEventScheduleBtn.addEventListener('click', () => this.saveEventSchedule());
                }

                const eventList = document.getElementById('eventList');
                if (eventList) {
                    eventList.addEventListener('input', (event) => {
                        const target = event.target;
                        const index = parseInt(target.getAttribute('data-index'), 10);
                        if (Number.isNaN(index)) return;
                        if (target.classList.contains('event-name')) {
                            this.eventSchedule[index].name = target.value;
                        }
                        if (target.classList.contains('event-description')) {
                            this.eventSchedule[index].description = target.value;
                        }
                    });

                    eventList.addEventListener('change', (event) => {
                        const target = event.target;
                        const index = parseInt(target.getAttribute('data-index'), 10);
                        if (Number.isNaN(index)) return;
                        if (target.classList.contains('event-playlist')) {
                            const file = target.value;
                            this.eventSchedule[index].playlistFile = file ? `playlists/${file}` : '';
                        }
                        if (target.classList.contains('event-loop')) {
                            this.eventSchedule[index].loop = target.checked;
                        }
                        if (target.classList.contains('event-inject')) {
                            this.eventSchedule[index].allowUserInject = target.checked;
                        }
                        if (target.classList.contains('event-dedupe')) {
                            this.eventSchedule[index].dedupeUserInject = target.checked;
                        }
                        if (target.classList.contains('event-inject-fallback')) {
                            this.eventSchedule[index].injectToFallback = target.checked;
                        }
                        if (target.classList.contains('event-active')) {
                            this.activeEventId = this.eventSchedule[index].id;
                        }
                    });

                    eventList.addEventListener('click', (event) => {
                        const target = event.target;
                        const index = parseInt(target.getAttribute('data-index'), 10);
                        if (Number.isNaN(index)) return;
                        if (target.classList.contains('event-move-up') && index > 0) {
                            const item = this.eventSchedule.splice(index, 1)[0];
                            this.eventSchedule.splice(index - 1, 0, item);
                            this.renderEventSchedule();
                        }
                        if (target.classList.contains('event-move-down') && index < this.eventSchedule.length - 1) {
                            const item = this.eventSchedule.splice(index, 1)[0];
                            this.eventSchedule.splice(index + 1, 0, item);
                            this.renderEventSchedule();
                        }
                        if (target.classList.contains('event-remove')) {
                            const removed = this.eventSchedule.splice(index, 1)[0];
                            if (removed && removed.id === this.activeEventId) {
                                this.activeEventId = this.eventSchedule[0]?.id || null;
                            }
                            this.renderEventSchedule();
                        }
                        if (target.classList.contains('event-use-backup')) {
                            const eventItem = this.eventSchedule[index];
                            if (!eventItem || !eventItem.playlistFile) return;
                            const base = eventItem.playlistFile.split('/').pop().replace(/\.js$/, '');
                            const backupFile = `${base}-backup.js`;
                            if (!this.playlistFiles.some(item => item.file === backupFile)) {
                                this.showToast('Backup playlist not found', 'error');
                                return;
                            }
                            eventItem.playlistFile = `playlists/${backupFile}`;
                            this.renderEventSchedule();
                            this.saveEventSchedule();
                        }
                    });
                }

                const fallbackSelect = document.getElementById('fallbackPlaylistFile');
                if (fallbackSelect) {
                    fallbackSelect.addEventListener('change', (event) => {
                        this.fallbackPlaylistFile = event.target.value;
                    });
                }
            }

            async loadSystemMode() {
                const select = document.getElementById('systemMode');
                if (!select) return;
                try {
                    const response = await fetch('/api/system-mode');
                    if (!response.ok) return;
                    const data = await response.json();
                    this.systemMode = data.mode || 'headless';
                    select.value = this.systemMode;
                } catch (error) {
                    // Ignore
                }
            }

            async saveSystemMode() {
                try {
                    const response = await fetch('/api/system-mode', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mode: this.systemMode })
                    });
                    if (!response.ok) {
                        throw new Error('Failed to save system mode');
                    }
                    this.showToast('System mode updated', 'success');
                } catch (error) {
                    this.showToast('Failed to update system mode', 'error');
                }
            }
            
            updateVisualizerSettingsVisibility() {
                const visualizerSettings = document.getElementById('visualizerSettings');
                if (this.settings.visualizerEnabled) {
                    visualizerSettings.style.display = 'block';
                } else {
                    visualizerSettings.style.display = 'none';
                }
            }

            async loadAudioOutputs() {
                const select = document.getElementById('audioOutputDevice');
                if (!select) return;
                try {
                    const response = await fetch('/api/audio/output');
                    if (!response.ok) return;
                    const data = await response.json();
                    const outputs = Array.isArray(data.outputs) ? data.outputs : [];
                    select.innerHTML = '';
                    outputs.forEach(output => {
                        const option = document.createElement('option');
                        option.value = output.id;
                        option.textContent = output.description
                            ? `${output.name} - ${output.description}`
                            : output.name;
                        select.appendChild(option);
                    });
                    const selected = data.device || this.settings.audioOutputDevice || 'default';
                    select.value = outputs.some(output => output.id === selected) ? selected : 'default';
                    this.settings.audioOutputDevice = select.value;
                } catch (error) {
                    // Ignore output enumeration errors
                }
            }

            async applyAudioOutput() {
                try {
                    await fetch('/api/audio/output', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ device: this.settings.audioOutputDevice })
                    });
                } catch (error) {
                    // Ignore errors; device may not be available
                }
            }

            async loadEventConfig() {
                try {
                    const response = await fetch('/api/event-config');
                    if (!response.ok) return;
                    this.eventConfig = await response.json();
                    if (!this.eventConfig.themeKey) {
                        this.eventConfig.themeKey = 'wedding';
                    }
                    await this.loadCustomPresets();
                    this.renderPresetCards();
                    this.syncPlaylistFileSelectors();
                    this.loadEventSchedule();
                } catch (error) {
                    // Ignore
                }
            }

            async loadPlaylistFiles() {
                try {
                    const response = await fetch('/api/playlists/files');
                    if (!response.ok) return;
                    const data = await response.json();
                    const files = Array.isArray(data.files) ? data.files : [];
                    this.playlistFiles = files.map((item) => {
                        if (typeof item === 'string') {
                            return { file: item, description: '' };
                        }
                        return {
                            file: item.file,
                            description: item.description || ''
                        };
                    }).filter(item => item.file);
                    this.renderPlaylistFileOptions();
                } catch (error) {
                    this.playlistFiles = [];
                }
            }

            renderPlaylistFileOptions() {
                const primarySelect = document.getElementById('primaryPlaylistFile');
                const secondarySelect = document.getElementById('secondaryPlaylistFile');
                if (!primarySelect || !secondarySelect) return;

                const escapeAttr = (value) => (value || '')
                    .replace(/&/g, '&amp;')
                    .replace(/"/g, '&quot;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                const options = this.playlistFiles.map(item => {
                    const label = item.description ? `${item.file} — ${item.description}` : item.file;
                    const title = item.description ? escapeAttr(item.description) : '';
                    const titleAttr = title ? ` title="${title}"` : '';
                    return `<option value="${item.file}"${titleAttr}>${label}</option>`;
                }).join('');
                primarySelect.innerHTML = `<option value="">Default (wedding-playlist.js)</option>${options}`;
                secondarySelect.innerHTML = `<option value="">Default (bride-playlist.js)</option>${options}`;
                this.syncPlaylistFileSelectors();
                this.renderEventSchedule();
            }

            syncPlaylistFileSelectors() {
                const primarySelect = document.getElementById('primaryPlaylistFile');
                const secondarySelect = document.getElementById('secondaryPlaylistFile');
                if (!primarySelect || !secondarySelect || !this.eventConfig) return;
                const normalize = (value) => value ? value.split('/').pop() : '';
                primarySelect.value = normalize(this.eventConfig.playlists?.primary?.file || '');
                secondarySelect.value = normalize(this.eventConfig.playlists?.secondary?.file || '');
            }

            async loadEventSchedule() {
                try {
                    const response = await fetch('/api/events');
                    if (!response.ok) return;
                    const data = await response.json();
                    this.eventSchedule = Array.isArray(data.events) ? data.events : [];
                    this.activeEventId = data.activeEventId || (this.eventSchedule[0] && this.eventSchedule[0].id) || null;
                    this.fallbackPlaylistFile = data.fallbackPlaylistFile ? data.fallbackPlaylistFile.split('/').pop() : '';
                    this.renderEventSchedule();
                } catch (error) {
                    // Ignore
                }
            }

            renderEventSchedule() {
                const container = document.getElementById('eventList');
                if (!container) return;
                if (!this.eventSchedule.length) {
                    container.innerHTML = '<div class="text-sm text-gray-400">No events configured yet.</div>';
                    return;
                }
                const escapeAttr = (value) => (value || '')
                    .replace(/&/g, '&amp;')
                    .replace(/"/g, '&quot;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                const options = this.playlistFiles.map(item => {
                    const label = item.description ? `${item.file} — ${item.description}` : item.file;
                    const title = item.description ? escapeAttr(item.description) : '';
                    const titleAttr = title ? ` title="${title}"` : '';
                    return `<option value="${item.file}"${titleAttr}>${label}</option>`;
                }).join('');
                const fallbackSelect = document.getElementById('fallbackPlaylistFile');
                if (fallbackSelect) {
                    fallbackSelect.innerHTML = `<option value="">Select fallback playlist</option>${options}`;
                    fallbackSelect.value = this.fallbackPlaylistFile || '';
                }
                container.innerHTML = this.eventSchedule.map((event, index) => {
                    if (typeof event.allowUserInject === 'undefined') {
                        event.allowUserInject = false;
                    }
                    if (typeof event.dedupeUserInject === 'undefined') {
                        event.dedupeUserInject = true;
                    }
                    if (typeof event.injectToFallback === 'undefined') {
                        event.injectToFallback = true;
                    }
                    const selectedFile = event.playlistFile ? event.playlistFile.split('/').pop() : '';
                    const loopChecked = event.loop !== false ? 'checked' : '';
                    const activeChecked = this.activeEventId === event.id ? 'checked' : '';
                    const injectChecked = event.allowUserInject ? 'checked' : '';
                    const dedupeChecked = event.dedupeUserInject !== false ? 'checked' : '';
                    const fallbackChecked = event.injectToFallback !== false ? 'checked' : '';
                    const description = event.description || '';
                    return `
                        <div class="bg-gray-800/70 border border-gray-700 rounded-xl p-4 grid grid-cols-1 xl:grid-cols-[auto_minmax(0,1fr)_minmax(0,1fr)_auto_auto_auto_auto] gap-3 items-center" data-index="${index}">
                            <label class="flex items-center gap-2 text-xs text-gray-300">
                                <input type="radio" name="activeEvent" class="event-active" data-index="${index}" ${activeChecked}>
                                Active
                            </label>
                            <input class="event-name w-full bg-gray-700 text-white rounded px-3 py-2 text-sm" data-index="${index}" value="${event.name || ''}" placeholder="Event name">
                            <select class="event-playlist w-full bg-gray-700 text-white rounded px-3 py-2 text-sm" data-index="${index}">
                                <option value="">Select playlist</option>
                                ${options}
                            </select>
                            <input class="event-description w-full bg-gray-700 text-white rounded px-3 py-2 text-sm xl:col-span-3" data-index="${index}" value="${description}" placeholder="Description (optional)">
                            <label class="flex items-center gap-2 text-xs text-gray-300">
                                <input type="checkbox" class="event-loop" data-index="${index}" ${loopChecked}>
                                Loop
                            </label>
                            <div class="flex flex-wrap gap-2 text-xs text-gray-300">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" class="event-inject" data-index="${index}" ${injectChecked}>
                                    Inject user songs
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" class="event-dedupe" data-index="${index}" ${dedupeChecked}>
                                    Dedupe
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" class="event-inject-fallback" data-index="${index}" ${fallbackChecked}>
                                    Also fallback
                                </label>
                            </div>
                            <button class="event-use-backup bg-amber-700 hover:bg-amber-600 text-white px-2 py-1 rounded text-xs" data-index="${index}">
                                Use Backup
                            </button>
                            <div class="flex gap-2">
                                <button class="event-move-up bg-slate-700 hover:bg-slate-600 text-white px-2 py-1 rounded text-xs" data-index="${index}" title="Move up">↑</button>
                                <button class="event-move-down bg-slate-700 hover:bg-slate-600 text-white px-2 py-1 rounded text-xs" data-index="${index}" title="Move down">↓</button>
                            </div>
                            <button class="event-remove bg-red-600 hover:bg-red-500 text-white px-2 py-1 rounded text-xs" data-index="${index}">Remove</button>
                        </div>
                    `;
                }).join('');

                container.querySelectorAll('.event-playlist').forEach((select, index) => {
                    const event = this.eventSchedule[index];
                    const selectedFile = event.playlistFile ? event.playlistFile.split('/').pop() : '';
                    select.value = selectedFile;
                });
            }

            createEventId(name) {
                const base = (name || 'event')
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/(^-|-$)/g, '') || 'event';
                let id = base;
                let counter = 1;
                const existing = new Set(this.eventSchedule.map(event => event.id));
                while (existing.has(id)) {
                    id = `${base}-${counter}`;
                    counter += 1;
                }
                return id;
            }

            addEvent() {
                const name = 'New Event';
                const playlistFile = this.playlistFiles[0]?.file ? `playlists/${this.playlistFiles[0].file}` : '';
                const event = {
                    id: this.createEventId(name),
                    name,
                    playlistFile,
                    description: '',
                    loop: true,
                    allowUserInject: false,
                    dedupeUserInject: true,
                    injectToFallback: true
                };
                this.eventSchedule.push(event);
                if (!this.activeEventId) {
                    this.activeEventId = event.id;
                }
                this.renderEventSchedule();
            }

            async saveEventSchedule() {
                const themeKey = this.eventConfig?.themeKey || 'wedding';
                try {
                    const response = await fetch('/api/events', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            themeKey,
                            events: this.eventSchedule,
                            activeEventId: this.activeEventId,
                            fallbackPlaylistFile: this.fallbackPlaylistFile ? `playlists/${this.fallbackPlaylistFile}` : ''
                        })
                    });
                    if (!response.ok) {
                        throw new Error('Failed to save events');
                    }
                    this.showToast('Event schedule saved', 'success');
                } catch (error) {
                    this.showToast('Failed to save event schedule', 'error');
                }
            }

            async uploadPlaylistFile() {
                const input = document.getElementById('playlistUploadInput');
                if (!input || !input.files || !input.files[0]) {
                    this.showToast('Choose a playlist file to upload', 'error');
                    return;
                }
                const formData = new FormData();
                formData.append('playlist', input.files[0]);
                try {
                    const response = await fetch('/api/playlists/upload', {
                        method: 'POST',
                        body: formData
                    });
                    if (!response.ok) {
                        throw new Error('Upload failed');
                    }
                    const data = await response.json();
                    this.showToast(`Uploaded ${data.filename}`, 'success');
                    input.value = '';
                    await this.loadPlaylistFiles();
                } catch (error) {
                    this.showToast('Failed to upload playlist', 'error');
                }
            }

            async createPlaylistFile() {
                const input = document.getElementById('createPlaylistName');
                if (!input) return;
                const name = input.value.trim();
                if (!name) {
                    this.showToast('Enter a playlist filename', 'error');
                    return;
                }
                try {
                    const response = await fetch('/api/playlists/file', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, playlist: [] })
                    });
                    if (!response.ok) {
                        throw new Error('Create failed');
                    }
                    input.value = '';
                    await this.loadPlaylistFiles();
                    this.showToast('Playlist file created', 'success');
                } catch (error) {
                    this.showToast('Failed to create playlist', 'error');
                }
            }

            async savePlaylistFiles() {
                if (!this.eventConfig) {
                    await this.loadEventConfig();
                }
                const primarySelect = document.getElementById('primaryPlaylistFile');
                const secondarySelect = document.getElementById('secondaryPlaylistFile');
                if (!primarySelect || !secondarySelect || !this.eventConfig) return;

                const updatedConfig = JSON.parse(JSON.stringify(this.eventConfig));
                updatedConfig.playlists = updatedConfig.playlists || {};
                updatedConfig.playlists.primary = updatedConfig.playlists.primary || {};
                updatedConfig.playlists.secondary = updatedConfig.playlists.secondary || {};
                updatedConfig.playlists.primary.file = primarySelect.value || '';
                updatedConfig.playlists.secondary.file = secondarySelect.value || '';

                try {
                    const response = await fetch('/api/event-config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updatedConfig)
                    });
                    if (!response.ok) {
                        throw new Error('Failed to save playlist files');
                    }
                    this.eventConfig = updatedConfig;
                    if (window.applyEventConfig) {
                        window.applyEventConfig(updatedConfig);
                    }
                    this.showToast('Playlist files updated', 'success');
                } catch (error) {
                    this.showToast('Failed to update playlist files', 'error');
                }
            }

            getEventPresets() {
                return {
                    wedding: {
                        appName: 'Wedding Jukebox',
                        eventName: 'Wedding',
                        tagline: 'Add songs and keep the party going',
                        themeKey: 'wedding',
                        theme: {
                            primary: '#6d28d9',
                            secondary: '#1f2937',
                            accent: '#f59e0b',
                            background: '#0f172a',
                            card: '#1f2937'
                        },
                        wifi: {
                            ssid: 'Wedding-Jukebox',
                            password: 'WeddingMusic2026'
                        },
                        playlists: {
                            primary: {
                                key: 'wedding',
                                file: 'playlists/wedding-playlist.js',
                                name: 'Wedding Party Playlist',
                                shortName: 'Wedding Party',
                                label: 'Wedding Playlist',
                                addedBy: '🎵 Wedding DJ'
                            },
                            secondary: {
                                key: 'bride',
                                file: 'playlists/bride-playlist.js',
                                name: "Bride's Elegant Playlist",
                                shortName: "Bride's Elegant",
                                label: "Bride's Playlist",
                                addedBy: "✨ Bride's Collection"
                            },
                            autoPlayLabel: '🎵 Wedding DJ Auto-Play'
                        },
                        eventsByTheme: {
                            wedding: {
                                activeEventId: 'ceremony',
                                fallbackPlaylistFile: 'playlists/wedding-playlist.js',
                                events: [
                                    { id: 'ceremony', name: 'Ceremony', playlistFile: 'playlists/wedding-ceremony.js', loop: false },
                                    { id: 'dinner', name: 'Dinner', playlistFile: 'playlists/wedding-dinner.js', loop: true },
                                    { id: 'first-dance', name: 'First Dance', playlistFile: 'playlists/wedding-first-dance.js', loop: false },
                                    { id: 'parents-dance', name: 'Parents Dance', playlistFile: 'playlists/wedding-parents-dance.js', loop: false },
                                    { id: 'bouquet-toss', name: 'Bouquet Toss', playlistFile: 'playlists/wedding-bouquet-toss.js', loop: false },
                                    { id: 'garter-toss', name: 'Garter Toss', playlistFile: 'playlists/wedding-garter-toss.js', loop: false },
                                    { id: 'party', name: 'Party', playlistFile: 'playlists/wedding-party.js', loop: true },
                                    { id: 'exit', name: 'Celebration Exit', playlistFile: 'playlists/wedding-exit.js', loop: false }
                                ]
                            }
                        }
                    },
                    dojo: {
                        appName: 'Karate Jukebox',
                        eventName: 'Dojo Night',
                        tagline: 'Focus, energy, and music between rounds',
                        themeKey: 'dojo',
                        theme: {
                            primary: '#ef4444',
                            secondary: '#111827',
                            accent: '#f97316',
                            background: '#0b0f1a',
                            card: '#1f2937'
                        },
                        wifi: {
                            ssid: 'Karate-Jukebox',
                            password: 'DojoMusic2026'
                        },
                        playlists: {
                            primary: {
                                key: 'wedding',
                                file: 'playlists/dojo-playlist.js',
                                name: 'Dojo Hype Playlist',
                                shortName: 'Dojo Hype',
                                label: 'Dojo Playlist',
                                addedBy: '🥋 Dojo DJ'
                            },
                            secondary: {
                                key: 'bride',
                                file: 'playlists/recovery-playlist.js',
                                name: 'Recovery & Focus',
                                shortName: 'Recovery',
                                label: 'Focus Playlist',
                                addedBy: '🧘 Dojo Crew'
                            },
                            autoPlayLabel: '🥋 Dojo Auto-Play'
                        },
                        eventsByTheme: {
                            dojo: {
                                activeEventId: 'kids-class',
                                fallbackPlaylistFile: 'playlists/dojo-playlist.js',
                                events: [
                                    { id: 'kids-class', name: 'Kids Class', playlistFile: 'playlists/dojo-playlist.js', loop: true },
                                    { id: 'teens-class', name: 'Teens Class', playlistFile: 'playlists/dojo-playlist.js', loop: true },
                                    { id: 'adult-class', name: 'Adult Class', playlistFile: 'playlists/dojo-playlist.js', loop: true },
                                    { id: 'sparring-kids', name: 'Sparring Kids', playlistFile: 'playlists/dojo-playlist.js', loop: true },
                                    { id: 'sparring-adults', name: 'Sparring Adults', playlistFile: 'playlists/dojo-playlist.js', loop: true },
                                    { id: 'recovery', name: 'Recovery', playlistFile: 'playlists/recovery-playlist.js', loop: true }
                                ]
                            }
                        }
                    },
                    house: {
                        appName: 'House Party Jukebox',
                        eventName: 'House Party',
                        tagline: 'Queue the bangers and keep it moving',
                        themeKey: 'house',
                        theme: {
                            primary: '#22c55e',
                            secondary: '#0f172a',
                            accent: '#38bdf8',
                            background: '#0b1325',
                            card: '#1e293b'
                        },
                        wifi: {
                            ssid: 'House-Party-Jukebox',
                            password: 'PartyTime2026'
                        },
                        playlists: {
                            primary: {
                                key: 'wedding',
                                file: 'wedding-playlist.js',
                                name: 'Party Starters',
                                shortName: 'Starters',
                                label: 'Party Playlist',
                                addedBy: '🎉 Party Host'
                            },
                            secondary: {
                                key: 'bride',
                                file: 'bride-playlist.js',
                                name: 'Late Night Chill',
                                shortName: 'Chill',
                                label: 'After Hours',
                                addedBy: '🌙 Chill Crew'
                            },
                            autoPlayLabel: '🎉 Party Auto-Play'
                        },
                        eventsByTheme: {
                            house: {
                                activeEventId: 'warmup',
                                fallbackPlaylistFile: 'playlists/house-party.js',
                                events: [
                                    { id: 'warmup', name: 'Warmup', playlistFile: 'playlists/house-warmup.js', loop: true },
                                    { id: 'party', name: 'Party Peak', playlistFile: 'playlists/house-party.js', loop: true },
                                    { id: 'late-night', name: 'Late Night Chill', playlistFile: 'playlists/house-late-night.js', loop: true }
                                ]
                            }
                        }
                    },
                    studio: {
                        appName: 'Training Studio Jukebox',
                        eventName: 'Training Session',
                        tagline: 'Keep the energy up between sets',
                        themeKey: 'studio',
                        theme: {
                            primary: '#3b82f6',
                            secondary: '#111827',
                            accent: '#a855f7',
                            background: '#0b1020',
                            card: '#1f2937'
                        },
                        wifi: {
                            ssid: 'Training-Jukebox',
                            password: 'StudioMix2026'
                        },
                        playlists: {
                            primary: {
                                key: 'wedding',
                                file: 'wedding-playlist.js',
                                name: 'Studio Pump',
                                shortName: 'Pump',
                                label: 'Training Playlist',
                                addedBy: '🏋️ Studio DJ'
                            },
                            secondary: {
                                key: 'bride',
                                file: 'bride-playlist.js',
                                name: 'Cooldown & Stretch',
                                shortName: 'Cooldown',
                                label: 'Recovery Playlist',
                                addedBy: '🧊 Studio Crew'
                            },
                            autoPlayLabel: '🏋️ Studio Auto-Play'
                        },
                        eventsByTheme: {
                            studio: {
                                activeEventId: 'warmup',
                                fallbackPlaylistFile: 'playlists/studio-workout.js',
                                events: [
                                    { id: 'warmup', name: 'Warmup', playlistFile: 'playlists/studio-warmup.js', loop: true },
                                    { id: 'workout', name: 'Workout', playlistFile: 'playlists/studio-workout.js', loop: true },
                                    { id: 'cooldown', name: 'Cooldown', playlistFile: 'playlists/studio-cooldown.js', loop: true }
                                ]
                            }
                        }
                    }
                };
            }

            getCustomPresets() {
                return this.customPresets || {};
            }

            saveCustomPresets(presets) {
                this.customPresets = presets || {};
            }

            async loadCustomPresets() {
                try {
                    const response = await fetch('/api/event-presets');
                    if (!response.ok) return;
                    const data = await response.json();
                    this.customPresets = data.presets || {};
                } catch (error) {
                    this.customPresets = {};
                }
            }

            renderPresetCards() {
                const container = document.getElementById('presetCards');
                if (!container) return;
                const presets = { ...this.getEventPresets(), ...this.getCustomPresets() };
                const entries = Object.entries(presets);
                if (!entries.length) {
                    container.innerHTML = '';
                    return;
                }
                container.innerHTML = entries.map(([key, preset]) => `
                    <div class="bg-gray-800/70 border border-gray-700 rounded-xl p-4 grid grid-cols-1 md:grid-cols-[minmax(0,1fr)_auto] gap-3 items-center">
                        <div class="space-y-1">
                            <div class="text-xs uppercase tracking-wide text-gray-400">Preset</div>
                            <div class="text-lg font-semibold text-white">${preset.appName || key}</div>
                            <div class="text-sm text-gray-300 leading-relaxed">${preset.tagline || 'Custom event setup'}</div>
                            <div class="text-xs text-gray-400">WiFi: <span class="text-gray-300">${preset.wifi?.ssid || 'Not set'}</span></div>
                        </div>
                        <div class="flex md:justify-end">
                            <button data-preset-key="${key}" class="preset-apply-btn w-full md:w-auto bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded text-sm font-semibold">
                                Apply
                            </button>
                        </div>
                    </div>
                `).join('');

                container.querySelectorAll('.preset-apply-btn').forEach((btn) => {
                    btn.addEventListener('click', () => {
                        const select = document.getElementById('eventPreset');
                        if (select) {
                            select.value = btn.getAttribute('data-preset-key');
                        }
                        this.applyPreset();
                    });
                });
            }

                async applyPreset() {
                    const select = document.getElementById('eventPreset');
                    if (!select) return;
                    const presetKey = select.value;
                if (!presetKey) {
                    this.showToast('Select a preset to apply', 'error');
                    return;
                }
                const presets = { ...this.getEventPresets(), ...this.getCustomPresets() };
                const preset = presets[presetKey];
                if (!preset) return;

                    try {
                        const response = await fetch('/api/event-config', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(preset)
                        });
                    if (!response.ok) {
                        throw new Error('Failed to save preset');
                    }
                    if (window.applyEventConfig) {
                        window.applyEventConfig(preset);
                    }
                    this.eventConfig = preset;
                    this.loadEventSchedule();
                    this.showToast('Event preset applied', 'success');
                } catch (error) {
                    this.showToast('Failed to apply preset', 'error');
                }
            }

            async saveCustomPreset() {
                const nameInput = document.getElementById('customPresetName');
                if (!nameInput) return;
                const name = nameInput.value.trim();
                if (!name) {
                    this.showToast('Enter a name for the preset', 'error');
                    return;
                }
                if (!this.eventConfig) {
                    await this.loadEventConfig();
                }
                const configToSave = this.eventConfig || {};
                if (!configToSave.appName || !configToSave.eventName) {
                    this.showToast('Current event config is incomplete', 'error');
                    return;
                }
                const key = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
                const presetPayload = { ...configToSave, appName: name };
                try {
                    const response = await fetch('/api/event-presets', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ key, preset: presetPayload })
                    });
                    if (!response.ok) {
                        throw new Error('Failed to save preset');
                    }
                    const presets = this.getCustomPresets();
                    presets[key] = presetPayload;
                    this.saveCustomPresets(presets);
                } catch (error) {
                    this.showToast('Failed to save preset', 'error');
                    return;
                }
                nameInput.value = '';
                const select = document.getElementById('eventPreset');
                if (select) {
                    if (!Array.from(select.options).some((opt) => opt.value === key)) {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = name;
                        select.appendChild(option);
                    }
                    select.value = key;
                }
                this.renderPresetCards();
                this.showToast('Custom preset saved', 'success');
            }
            
            resetToDefaults() {
                if (confirm('Are you sure you want to reset all settings to defaults?')) {
                    localStorage.removeItem('jukeboxSettings');
                    location.reload();
                }
            }
            
            showToast(message, type) {
                // Simple toast notification
                const toast = document.createElement('div');
                toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-semibold z-50 ${
                    type === 'success' ? 'bg-green-600' : 'bg-red-600'
                }`;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }
        }
        
        // Initialize settings manager
        const settingsManager = new SettingsManager();
    </script>
</body>
</html>
